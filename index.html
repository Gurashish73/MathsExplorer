<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathify: All-in-One</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Math.js (Symbolic Math Engine) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
    
    <!-- 3. Chart.js (2D Graphing) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    
    <!-- 4. Three.js (3D Graphing) - r128 includes ParametricGeometry -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- 5. MathJax (for LaTeX Rendering) -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- NEW: Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make functions globally available for the main script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            setLogLevel
        };
    </script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style for the 'steps' output */
        .steps-output {
            background-color: #1a202c; /* bg-gray-900 */
            border: 1px solid #4a5568; /* border-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 100px; /* Added min-height */
        }
        
        /* Styles for the chat window */
        .chat-window {
            background-color: #1a202c; /* bg-gray-900 */
            border: 1px solid #4a5568; /* border-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            overflow-y: auto;
            height: 500px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            max-width: 80%;
            white-space: pre-wrap; /* Kept for newlines */
            line-height: 1.6;
            word-wrap: break-word; /* Added */
        }
        .user-message {
            background-color: #2d3748; /* bg-gray-700 */
            align-self: flex-end;
            color: #e2e8f0; /* text-gray-200 */
        }
        .model-message {
            background-color: #3f4a5f; /* bg-gray-600 */
            align-self: flex-start;
            color: #e2e8f0; /* text-gray-200 */
        }
        .user-message img {
            max-width: 200px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Styling for rendered markdown */
        .chat-message ul, .chat-message ol {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .chat-message ul { list-style-type: disc; }
        .chat-message ol { list-style-type: decimal; }
        .chat-message li { margin-bottom: 0.25rem; }
        .chat-message strong { color: #fff; font-weight: 600; }
        .chat-message em { font-style: italic; }
        .chat-message code {
            background-color: #1a202c;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .chat-message pre {
            background-color: #1a202c;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .chat-message pre code { padding: 0; background-color: transparent; }
        
        #image-preview-container img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid #4a5568;
        }
        
        /* Ensure canvas is responsive */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        /* Styles for 3D Canvases */
        #three-canvas, #three-grapher-canvas, #vector-canvas {
            width: 100%;
            height: 400px;
            border-radius: 0.5rem;
            background-color: #000;
        }
        
        /* --- UPDATED: Custom SVG styles for Unit Circle --- */
        #unit-circle-svg { 
            cursor: pointer; 
            touch-action: none; 
            font-family: monospace;
            font-size: 10px;
        }
        #unit-circle-handle { cursor: grab; }
        #unit-circle-handle:active { cursor: grabbing; }
        /* Style for the angle arc */
        #unit-angle-arc {
            fill: #f87171;
            opacity: 0.3;
        }
        /* Style for the reference lines */
        .reference-line {
            stroke-dasharray: 4;
            stroke-width: 1.5;
        }
        #unit-opposite { stroke: #34d399; } /* sin (green) */
        #unit-adjacent { stroke: #60a5fa; } /* cos (blue) */
        #unit-hypotenuse { stroke: #f87171; } /* radius (red) */
        /* Style for text labels */
        .svg-text {
            fill: #e2e8f0;
            font-size: 10px;
        }
        .svg-text-sin { fill: #34d399; }
        .svg-text-cos { fill: #60a5fa; }
        /* --- END UPDATED STYLES --- */

        /* Simple loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Button style for AI explainers */
        .ai-explain-btn {
            background-color: #7c3aed; /* purple-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-top: 1rem;
            border: none;
            width: 100%;
            font-size: 0.875rem;
        }
        .ai-explain-btn:hover {
            background-color: #6d28d9; /* purple-700 */
        }
        
        /* Style for small "Why" button */
        .ai-why-btn {
            background-color: #4a5568; /* bg-gray-600 */
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.25rem; /* 20px */
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem; /* 8px */
            padding-bottom: 2px; /* Center emoji */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            flex-shrink: 0; /* Prevent shrinking in flex */
        }
        .ai-why-btn:hover {
            background-color: #6d28d9; /* purple-700 */
        }
        
        /* Button for AI Analyzer */
        .ai-analyze-btn {
            background-color: #0d9488; /* teal-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            border: none;
            font-size: 0.875rem;
        }
        .ai-analyze-btn:hover {
            background-color: #0f766e; /* teal-700 */
        }
        
        /* Shared button styles for tabs */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-medium;
            border-radius: 0.375rem 0.375rem 0 0;
            border-bottom-width: 2px;
            border-color: transparent;
            transition: all 0.2s;
        }
        .tab-btn-active {
            border-color: #3b82f6; /* blue-500 */
            color: #ffffff;
            background-color: #2563eb; /* blue-600 */
        }
        .tab-btn-inactive {
            color: #9ca3af; /* gray-400 */
            background-color: #374151; /* gray-700 */
            hover:bg-gray-600;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">

    <!-- Header and Navigation -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold text-white">ðŸš€ MATHIFY</span>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                    <!-- Navigation Buttons -->
                    <button data-module="algebra" class="nav-btn bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium">Algebra Solver</button>
                    <button data-module="calculus" class="nav-btn text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Calculus Lab</button>
                    <button data-module="trig" class="nav-btn text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Trig Hub</button>
                    <!-- NEW: Vector Lab Button -->
                    <button data-module="vector-lab" class="nav-btn text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Vector Lab</button>
                    <button data-module="3d-grapher" class="nav-btn text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">3D Grapher</button>
                    <button data-module="ai-tutor" class="nav-btn text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">AI Math Tutor</button>
                </div>
                <!-- Mobile menu button (simple) -->
                <div class="sm:hidden">
                    <select id="mobile-nav" class="bg-gray-700 text-white rounded-md p-2">
                        <option value="algebra">Algebra Solver</option>
                        <option value="calculus">Calculus Lab</option>
                        <option value:="trig">Trig Hub</option>
                        <!-- NEW: Vector Lab Option -->
                        <option value="vector-lab">Vector Lab</option>
                        <option value="3d-grapher">3D Grapher</option>
                        <option value="ai-tutor">AI Math Tutor</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- =================================================================== -->
        <!-- MODULE 1: ALGEBRA SOLVER -->
        <!-- =================================================================== -->
        <div id="algebra-module" class="module-content">
            <h1 class="text-3xl font-bold mb-6 text-white">Algebra Solver</h1>
            
            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="algebra-tab-btn" data-tab="algebra-system-solver" role="tab">System Solver</button>
                    <button class="algebra-tab-btn" data-tab="algebra-polynomial-roots" role="tab">Polynomial Roots</button>
                    <button class="algebra-tab-btn" data-tab="algebra-matrix-calc" role="tab">Matrix Calculator</button>
                </nav>
            </div>

            <!-- Tab Content: System Solver -->
            <div id="algebra-system-solver" class="algebra-tab-content">
                <!-- Controls -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="text-lg font-medium">Select Variables:</label>
                        <button id="btn-2-vars" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">2 Variables</button>
                        <button id="btn-3-vars" class="px-4 py-2 rounded-md bg-gray-600 text-white font-semibold">3 Variables</button>
                    </div>
                    
                    <!-- 2-Variable Inputs -->
                    <div id="inputs-2-vars" class="space-y-3">
                        <p class="text-gray-400">Enter coefficients for: \(a_1x + b_1y = d_1\) and \(a_2x + b_2y = d_2\)</p>
                        <div class="grid grid-cols-3 gap-4">
                            <input id="a1" type="number" placeholder="a1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="2">
                            <input id="b1" type="number" placeholder="b1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                            <input id="d1" type="number" placeholder="d1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="5">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <input id="a2" type="number" placeholder="a2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                            <input id="b2" type="number" placeholder="b2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="-1">
                            <input id="d2" type="number" placeholder="d2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                        </div>
                    </div>

                    <!-- 3-Variable Inputs -->
                    <div id="inputs-3-vars" class="space-y-3 hidden">
                        <p class="text-gray-400">Enter coefficients for: \(ax + by + cz = d\)</p>
                        <div class="grid grid-cols-4 gap-4">
                            <input id="a3" type="number" placeholder="a1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                            <input id="b3" type="number" placeholder="b1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                            <input id="c3" type="number" placeholder="c1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="2">
                            <input id="d3" type="number" placeholder="d1" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="9">
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <input id="a4" type="number" placeholder="a2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="2">
                            <input id="b4" type="number" placeholder="b2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="4">
                            <input id="c4" type="number" placeholder="c2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="-3">
                            <input id="d4" type="number" placeholder="d2" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <input id="a5" type="number" placeholder="a3" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="3">
                            <input id="b5" type="number" placeholder="b3" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="6">
                            <input id="c5" type="number" placeholder="c3" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="-5">
                            <input id="d5" type="number" placeholder="d3" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                        </div>
                    </div>

                    <button id="solve-algebra" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        Solve and Visualize
                    </button>
                </div>
                
                <!-- Visualization and Solution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Visualization -->
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4 text-white">Visualization</h2>
                        <!-- 2D Canvas -->
                        <div id="chart-2d-container" class="chart-container">
                            <canvas id="algebra-chart-2d"></canvas>
                        </div>
                        <!-- 3D Canvas -->
                        <div id="chart-3d-container" class="hidden">
                            <div id="three-canvas"></div>
                            <p class="text-center text-gray-400 mt-2">Click and drag to rotate. Scroll to zoom.</p>
                        </div>
                    </div>
                    <!-- Solution and Steps -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-white">Solution & Steps</h2>
                            <button id="explain-algebra-btn" class="ai-why-btn hidden" title="Explain this solution method">ðŸ¤–</button>
                        </div>
                        <div id="algebra-solution" class="text-xl font-bold text-green-400 mb-4"></div>
                        <div id="algebra-steps" class="steps-output text-gray-300">Enter coefficients and click solve.</div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Polynomial Roots -->
            <div id="algebra-polynomial-roots" class="algebra-tab-content hidden">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                    <p class="text-gray-400 mb-4">Find roots for: \(ax^3 + bx^2 + cx + d = 0\)</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <input id="poly-a" type="number" placeholder="a (xÂ³)" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                        <input id="poly-b" type="number" placeholder="b (xÂ²)" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                        <input id="poly-c" type="number" placeholder="c (x)" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="-4">
                        <input id="poly-d" type="number" placeholder="d" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                    </div>
                    <button id="solve-poly" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        Find Roots and Graph
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4 text-white">Polynomial Graph</h2>
                        <div class="chart-container">
                            <canvas id="poly-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-white">Roots</h2>
                            <button id="explain-poly-btn" class="ai-why-btn hidden" title="Explain how to find these roots">ðŸ¤–</button>
                        </div>
                        <div id="poly-solution" class="text-lg font-bold text-green-400 mb-4"></div>
                        <div id="poly-steps" class="steps-output text-gray-300">Enter coefficients to find roots.</div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Matrix Calculator -->
            <div id="algebra-matrix-calc" class="algebra-tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
                        <h2 class="text-2xl font-bold text-white">Matrix A</h2>
                        <div class="grid grid-cols-3 gap-2">
                            <input id="A-00" type="number" value="1" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-01" type="number" value="2" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-02" type="number" value="3" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-10" type="number" value="4" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-11" type="number" value="5" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-12" type="number" value="6" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-20" type="number" value="7" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-21" type="number" value="8" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="A-22" type="number" value="9" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                        </div>
                        <h2 class="text-2xl font-bold text-white">Matrix B</h2>
                        <div class="grid grid-cols-3 gap-2">
                            <input id="B-00" type="number" value="9" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-01" type="number" value="8" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-02" type="number" value="7" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-10" type="number" value="6" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-11" type="number" value="5" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-12" type="number" value="4" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-20" type="number" value="3" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-21" type="number" value="2" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <input id="B-22" type="number" value="1" class="p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                        </div>
                    </div>
                    <!-- Operations & Result -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold text-white">Operations</h2>
                        <div class="grid grid-cols-3 gap-4 my-4">
                            <button class="matrix-op-btn" data-op="add">A + B</button>
                            <button class="matrix-op-btn" data-op="subtract">A - B</button>
                            <button class="matrix-op-btn" data-op="multiply">A * B</button>
                            <button class="matrix-op-btn" data-op="detA">det(A)</button>
                            <button class="matrix-op-btn" data-op="invA">inv(A)</button>
                            <button class="matrix-op-btn" data-op="adjA">adj(A)</button>
                            <button class="matrix-op-btn" data-op="detB">det(B)</button>
                            <button class="matrix-op-btn" data-op="invB">inv(B)</button>
                            <button class="matrix-op-btn" data-op="adjB">adj(B)</button>
                        </div>
                        <div class="flex items-center justify-between mt-6">
                            <h2 class="text-2xl font-bold text-white">Result</h2>
                            <button id="explain-matrix-btn" class="ai-why-btn hidden" title="Explain this matrix operation">ðŸ¤–</button>
                        </div>
                        <div id="matrix-result-scalar" class="text-xl font-bold text-green-400 my-2"></div>
                        <div id="matrix-result-grid" class="grid grid-cols-3 gap-2 mt-4 hidden">
                            <div class="matrix-result-cell"></div><div class="matrix-result-cell"></div><div class="matrix-result-cell"></div>
                            <div class="matrix-result-cell"></div><div class="matrix-result-cell"></div><div class="matrix-result-cell"></div>
                            <div class="matrix-result-cell"></div><div class="matrix-result-cell"></div><div class="matrix-result-cell"></div>
                        </div>
                        <div id="matrix-error" class="text-red-400 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- =================================================================== -->
        <!-- MODULE 2: CALCULUS LAB -->
        <!-- =================================================================== -->
        <div id="calculus-module" class="module-content hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">Calculus Lab</h1>

            <!-- Input -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <label for="calc-function" class="block text-lg font-medium mb-2">Enter function \(f(x)\):</label>
                <input id="calc-function" type="text" placeholder="e.g., x^2, sin(x), x^3 - 2*x" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" value="x^2">
                <div class="mt-4 flex flex-col sm:flex-row gap-4">
                    <button id="calc-update-all" class="w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        Run All
                    </button>
                    <!-- NEW: AI Analyze Button -->
                    <button id="ai-analyze-calc-btn" class="w-full sm:w-1/2 ai-analyze-btn">
                        ðŸ¤– Analyze this Function
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="calc-tab-btn" data-tab="calc-graph" role="tab">Graph</button>
                    <button class="calc-tab-btn" data-tab="calc-derivative" role="tab">Derivative</button>
                    <button class="calc-tab-btn" data-tab="calc-integral" role="tab">Integral (Riemann Sum)</button>
                    <button class="calc-tab-btn" data-tab="calc-limit" role="tab">Limit Explorer</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div>
                <!-- Graph Tab -->
                <div id="calc-graph" class="calc-tab-content">
                    <h2 class="text-2xl font-bold mb-4 text-white">Function Graph</h2>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <div class="chart-container">
                            <canvas id="calc-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Derivative Tab -->
                <div id="calc-derivative" class="calc-tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-white">Symbolic Derivative</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="steps-output">
                            <span class="text-gray-400">\(f(x) = \)</span>
                            <span id="deriv-fx" class="text-white"></span>
                            <br><br>
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-gray-400">\(f'(x) = \frac{d}{dx}[f(x)] = \)</span>
                                    <span id="deriv-fpx" class="text-xl text-green-400"></span>
                                </div>
                                <button id="explain-derivative-btn" class="ai-why-btn" title="Explain this derivative">ðŸ¤–</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integral (Riemann) Tab -->
                <div id="calc-integral" class="calc-tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-white">Definite Integral (Riemann Sum)</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="integral-a" class="block text-sm font-medium text-gray-400">From (a):</label>
                                <input id="integral-a" type="number" value="-2" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="integral-b" class="block text-sm font-medium text-gray-400">To (b):</label>
                                <input id="integral-b" type="number" value="2" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="integral-n" class="block text-sm font-medium text-gray-400">Rectangles (n): <span id="integral-n-label">10</span></label>
                                <input id="integral-n" type="range" min="1" max="100" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="integral-chart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-lg">Approximate Area: </span>
                            <span id="integral-area" class="text-2xl font-bold text-green-400">...</span>
                            <button id="explain-integral-btn" class="ai-why-btn hidden" title="Explain this Riemann sum">ðŸ¤–</button>
                        </div>
                    </div>
                </div>

                <!-- Limit Tab -->
                <div id="calc-limit" class="calc-tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-white">Limit Explorer</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="flex items-center space-x-2 mb-4">
                            <span class="text-lg">\(\lim_{x \to}\)</span>
                            <input id="limit-a" type="number" value="0" class="w-24 p-2 rounded bg-gray-700 text-white border border-gray-600">
                            <span id="limit-fx" class="text-lg ml-2">\(f(x)\)</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <table class="w-full text-left table-auto">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="p-3">x (approaching from left)</th>
                                        <th class="p-3">f(x)</th>
                                    </tr>
                                </thead>
                                <tbody id="limit-table-left" class="bg-gray-900">
                                    <!-- Rows generated by JS -->
                                </tbody>
                            </table>
                            <table class="w-full text-left table-auto">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="p-3">x (approaching from right)</th>
                                        <th class="p-3">f(x)</th>
                                    </tr>
                                </thead>
                                <tbody id="limit-table-right" class="bg-gray-900">
                                    <!-- Rows generated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-lg">Approaching: </span>
                            <span id="limit-value" class="text-2xl font-bold text-green-400">...</span>
                            <button id="explain-limit-btn" class="ai-why-btn hidden" title="Explain this limit">ðŸ¤–</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- =================================================================== -->
        <!-- MODULE 3: TRIG HUB -->
        <!-- =================================================================== -->
        <div id="trig-module" class="module-content hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">Trigonometry Hub</h1>
            
            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="trig-tab-btn" data-tab="trig-unit-circle" role="tab">Unit Circle</button>
                    <button class="trig-tab-btn" data-tab="trig-triangle-solver" role="tab">Triangle Solver</button>
                </nav>
            </div>

            <!-- Unit Circle Tab -->
            <div id="trig-unit-circle" class="trig-tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Unit Circle SVG -->
                    <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-xl flex justify-center items-center">
                        <!-- UPDATED SVG -->
                        <svg id="unit-circle-svg" viewBox="0 0 300 300" class="w-full max-w-md">
                            <defs>
                                <!-- Grid lines pattern -->
                                <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
                                    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#4a5568" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <!-- Bounding box and grid -->
                            <rect width="300" height="300" fill="url(#grid)" stroke="#4a5568" stroke-width="1"/>
                            
                            <!-- Origin and Axes -->
                            <g transform="translate(150, 150)">
                                <!-- Axes -->
                                <line x1="-150" y1="0" x2="150" y2="0" stroke="#6b7280" stroke-width="1"/>
                                <line x1="0" y1="-150" x2="0" y2="150" stroke="#6b7280" stroke-width="1"/>
                                <!-- Axis Labels -->
                                <text class="svg-text" x="135" y="-5">x</text>
                                <text class="svg-text" x="5" y="-135">y</text>
                                <text class="svg-text" x="123" y="12">(1,0)</text>
                                <text class="svg-text" x="-145" y="12">(-1,0)</text>
                                <text class="svg-text" x="-10" y="-123">(0,1)</text>
                                <text class="svg-text" x="-10" y="133">(0,-1)</text>
                                
                                <!-- Unit Circle -->
                                <circle r="120" fill="none" stroke="#3b82f6" stroke-width="2"/>
                                
                                <!-- Angle Arc -->
                                <path id="unit-angle-arc" d="M 120 0 A 120 120 0 0 1 120 0"></path>

                                <!-- Reference Triangle -->
                                <line id="unit-adjacent" class="reference-line" x1="0" y1="0" x2="120" y2="0"/>
                                <line id="unit-opposite" class="reference-line" x1="120" y1="0" x2="120" y2="0"/>
                                <line id="unit-hypotenuse" class="reference-line" x1="0" y1="0" x2="120" y2="0"/>
                                
                                <!-- Triangle Labels -->
                                <text id="cos-label" class="svg-text svg-text-cos" x="60" y="12">cos(Î¸)</text>
                                <text id="sin-label" class="svg-text svg-text-sin" x="125" y="0">sin(Î¸)</text>

                                <!-- Handle -->
                                <circle id="unit-circle-handle" r="8" fill="#f87171" transform="translate(120, 0)"/>
                            </g>
                        </svg>
                        <!-- END UPDATED SVG -->
                    </div>
                    <!-- Values -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4 text-white">Live Values</h2>
                        <div class="space-y-4">
                            <!-- NEW: Input Fields -->
                            <div>
                                <label for="uc-angle-deg-input" class="block text-sm font-medium text-gray-400">Angle (Î¸) in Degrees:</label>
                                <input id="uc-angle-deg-input" type="number" step="0.1" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" value="0.0">
                            </div>
                            <div>
                                <label for="uc-angle-rad-input" class="block text-sm font-medium text-gray-400">Angle (Î¸) in Radians:</label>
                                <input id="uc-angle-rad-input" type="text" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" value="0.00">
                            </div>
                            <!-- END NEW -->

                            <hr class="border-gray-600"/>
                            <div class="text-lg">
                                <span class="text-blue-400 font-medium">cos(Î¸) (x):</span>
                                <span id="uc-cos" class="font-bold text-white ml-2">1.000</span>
                            </div>
                            <div class="text-lg">
                                <span class="text-green-400 font-medium">sin(Î¸) (y):</span>
                                <span id="uc-sin" class="font-bold text-white ml-2">0.000</span>
                            </div>
                            <div class="text-lg">
                                <span class="text-red-400 font-medium">tan(Î¸) (y/x):</span>
                                <span id="uc-tan" class="font-bold text-white ml-2">0.000</span>
                            </div>
                        </div>
                        <div class="chart-container h-48 mt-6">
                            <canvas id="trig-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Triangle Solver Tab -->
            <div id="trig-triangle-solver" class="trig-tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4 text-white">Triangle Solver</h2>
                        <p class="text-gray-400 mb-4">Enter 3 known values. (Use 'A' for Angle A, 'a' for Side a).</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="tri-a" class="block text-sm font-medium">Side a</label>
                                <input id="tri-a" type="number" placeholder="Side a" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="tri-A" class="block text-sm font-medium">Angle A (deg)</label>
                                <input id="tri-A" type="number" placeholder="Angle A" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="tri-b" class="block text-sm font-medium">Side b</label>
                                <input id="tri-b" type="number" placeholder="Side b" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="tri-B" class="block text-sm font-medium">Angle B (deg)</label>
                                <input id="tri-B" type="number" placeholder="Angle B" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="tri-c" class="block text-sm font-medium">Side c</label>
                                <input id="tri-c" type="number" placeholder="Side c" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                            <div>
                                <label for="tri-C" class="block text-sm font-medium">Angle C (deg)</label>
                                <input id="tri-C" type="number" placeholder="Angle C" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                            </div>
                        </div>
                        <button id="solve-triangle" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                            Solve Triangle
                        </button>
                    </div>
                    <!-- Results -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-white">Results & Steps</h2>
                            <button id="explain-trig-btn" class="ai-why-btn hidden" title="Explain this solution method">ðŸ¤–</button>
                        </div>
                        <div id="triangle-solution" class="text-lg font-bold text-green-400 mb-4"></div>
                        <div id="triangle-steps" class="steps-output text-gray-300">Enter 3 values to solve.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- =================================================================== -->
        <!-- NEW MODULE 4: VECTOR LAB -->
        <!-- =================================================================== -->
        <div id="vector-lab-module" class="module-content hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">3D Vector Lab</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Inputs & Results -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <!-- Inputs -->
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-4">Inputs</h2>
                        <!-- Vector 1 -->
                        <div class="flex items-center space-x-2 mb-3">
                            <label class="text-lg font-medium text-blue-400">v1 = (</label>
                            <input id="v1_x" type="number" value="1" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>,</label>
                            <input id="v1_y" type="number" value="2" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>,</label>
                            <input id="v1_z" type="number" value="3" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>)</label>
                        </div>
                        <!-- Vector 2 -->
                        <div class="flex items-center space-x-2">
                            <label class="text-lg font-medium text-green-400">v2 = (</label>
                            <input id="v2_x" type="number" value="4" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>,</label>
                            <input id="v2_y" type="number" value="5" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>,</label>
                            <input id="v2_z" type="number" value="6" class="w-20 p-2 text-center rounded bg-gray-700 text-white border border-gray-600">
                            <label>)</label>
                        </div>
                        <button id="vector-calculate-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                            Calculate & Visualize
                        </button>
                    </div>
                    
                    <!-- Results -->
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-4">Results</h2>
                        <div id="vector-results" class="steps-output text-lg">
                            Click calculate to see vector operations.
                        </div>
                    </div>
                </div>
                
                <!-- Visualization -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-white">Visualization</h2>
                    <div id="vector-canvas"></div>
                    <p class="text-center text-gray-400 mt-2">Click and drag to rotate. Scroll to zoom.</p>
                </div>
            </div>
        </div>


        <!-- =================================================================== -->
        <!-- MODULE 5: 3D FUNCTION GRAPHER -->
        <!-- =================================================================== -->
        <div id="3d-grapher-module" class="module-content hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">3D Function Grapher</h1>
            
            <!-- Input -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <!-- NEW: Mode Toggle -->
                <div class="flex mb-4 rounded-lg bg-gray-700 p-1">
                    <button id="grapher-mode-explicit" class="tab-btn w-1/2 tab-btn-active">
                        Explicit: z = f(x, y)
                    </button>
                    <button id="grapher-mode-parametric" class="tab-btn w-1/2 tab-btn-inactive">
                        Parametric: (x, y, z)(u, v)
                    </button>
                </div>

                <!-- Explicit Inputs -->
                <div id="explicit-inputs">
                    <label for="3d-function" class="block text-lg font-medium mb-2">Enter function \(z = f(x, y)\):</label>
                    <input id="3d-function" type="text" placeholder="e.g., sin(sqrt(x^2+y^2))" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" value="sin(sqrt(x^2 + y^2))">
                </div>

                <!-- Parametric Inputs -->
                <div id="parametric-inputs" class="hidden space-y-3">
                    <p class="text-gray-400">Enter functions of u and v (from 0 to 1). Default is a Torus.</p>
                    <div>
                        <label for="3d-func-x" class="block text-sm font-medium text-gray-400">\(x(u, v) = \)</label>
                        <input id="3d-func-x" type="text" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" value="(3 + 1 * cos(v * 2 * PI)) * cos(u * 2 * PI)">
                    </div>
                    <div>
                        <label for="3d-func-y" class="block text-sm font-medium text-gray-400">\(y(u, v) = \)</label>
                        <input id="3d-func-y" type="text" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" value="(3 + 1 * cos(v * 2 * PI)) * sin(u * 2 * PI)">
                    </div>
                    <div>
                        <label for="3d-func-z" class="block text-sm font-medium text-gray-400">\(z(u, v) = \)</label>
                        <input id="3d-func-z" type="text" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" value="1 * sin(v * 2 * PI)">
                    </div>
                </div>

                <div class="mt-4 flex flex-col sm:flex-row gap-4">
                    <button id="graph-3d-btn" class="w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        Graph Function
                    </button>
                    <!-- NEW: AI Analyze Button -->
                    <button id="ai-analyze-3d-btn" class="w-full sm:w-1/2 ai-analyze-btn">
                        ðŸ¤– Analyze (Explicit only)
                    </button>
                </div>

                <!-- NEW: Collaboration Section -->
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <h3 class="text-lg font-semibold text-white mb-2">Collaboration</h3>
                    <button id="start-share-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                        Start Sharing Session
                    </button>
                    <div id="share-info-box" class="hidden mt-4 space-y-2">
                        <label class="block text-sm font-medium text-gray-400">Share this link with a friend:</label>
                        <div class="flex gap-2">
                            <input type="text" id="share-link-input" readonly class="w-full p-2 rounded bg-gray-900 text-gray-300 border border-gray-600">
                            <button id="copy-link-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">Copy</button>
                        </div>
                        <button id="leave-session-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200 mt-2">
                            Leave Session
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Visualization -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-white">Visualization</h2>
                <div id="three-grapher-canvas"></div>
                <p class="text-center text-gray-400 mt-2">Click and drag to rotate. Scroll to zoom.</p>
                <div id="graph-3d-error" class="text-red-400 mt-2 text-center"></div>
            </div>
        </div>


        <!-- =================================================================== -->
        <!-- MODULE 6: AI MATH TUTOR -->
        <!-- =================================================================== -->
        <div id="ai-tutor-module" class="module-content hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">AI Math Tutor</h1>
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <label for="ai-problem-input" class="block text-lg font-medium mb-2">Enter any math problem:</label>
                <textarea id="ai-problem-input" rows="4" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="e.g., Solve 3x^2 - 4x + 1 = 0, or 'what is the derivative of sin(x^2)?'"></textarea>
                
                <!-- Image Upload and Chat Controls -->
                <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <label for="ai-image-upload" class="cursor-pointer text-blue-400 hover:text-blue-300">
                            Upload Image (optional)
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                        </label>
                        <input type="file" id="ai-image-upload" class="hidden" accept="image/*">
                        <div id="image-preview-container" class="mt-2"></div>
                    </div>
                    <button id="ai-clear-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                        Clear Chat
                    </button>
                </div>
                
                <button id="ai-solve-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                    Ask AI
                </button>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-white">Chat</h2>
                <div id="ai-loader" class="loader hidden"></div>
                <div id="ai-solution" class="chat-window text-gray-300 text-lg leading-relaxed"></div>
            </div>
        </div>

    </div> <!-- end container -->

    <!-- =================================================================== -->
    <!-- JAVASCRIPT LOGIC -->
    <!-- =================================================================== -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // --- Firebase Globals ---
            let db, auth, appId, userId;
            let currentSessionId = null;
            let sessionUnsubscribe = null;
            let isUpdatingFromFirestore = false;
            let lastCameraUpdate = 0;
            const DEBOUNCE_TIME = 200; // ms for camera sync

            // --- Firebase Functions ---
            async function initFirebase() {
                try {
                    // Get Firebase config and App ID from global scope (provided by environment)
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (!firebaseConfig) {
                        console.error("Firebase config is missing.");
                        return;
                    }

                    // Initialize Firebase
                    const app = window.firebase.initializeApp(firebaseConfig);
                    auth = window.firebase.getAuth(app);
                    db = window.firebase.getFirestore(app);
                    window.firebase.setLogLevel('debug');

                    // Sign in
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await window.firebase.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await window.firebase.signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    console.log("Firebase initialized, User ID:", userId);

                } catch (err) {
                    console.error("Error initializing Firebase:", err);
                }
            }

            // Checks URL for a session ID and joins if found
            function checkUrlForSession() {
                const params = new URLSearchParams(window.location.search);
                const sessionId = params.get('session');
                if (sessionId) {
                    console.log("Found session ID in URL, joining:", sessionId);
                    // Switch to 3D grapher and join
                    switchModule('3d-grapher');
                    joinShareSession(sessionId);
                }
            }

            // --- Collaboration Functions ---

            // Gets the current state of the 3D grapher UI
            function getGrapherState() {
                return {
                    mode: grapherMode,
                    explicitFunc: document.getElementById('3d-function').value,
                    paramX: document.getElementById('3d-func-x').value,
                    paramY: document.getElementById('3d-func-y').value,
                    paramZ: document.getElementById('3d-func-z').value
                };
            }

            // Sets the 3D grapher UI from a state object
            function setGrapherState(state) {
                if (!state) return;
                isUpdatingFromFirestore = true;
                
                if (state.mode === 'parametric') {
                    parametricBtn.click(); // This click updates grapherMode
                    document.getElementById('3d-func-x').value = state.paramX;
                    document.getElementById('3d-func-y').value = state.paramY;
                    document.getElementById('3d-func-z').value = state.paramZ;
                } else {
                    explicitBtn.click();
                    document.getElementById('3d-function').value = state.explicitFunc;
                }
                
                // Trigger the graph update
                update3DGraph();
                
                // Release the lock after a short delay
                setTimeout(() => { isUpdatingFromFirestore = false; }, 100);
            }

            // Creates a new sharing session
            function startNewShareSession() {
                const sessionId = crypto.randomUUID();
                joinShareSession(sessionId);
            }

            // Joins a specific session ID and listens for changes
            function joinShareSession(sessionId) {
                if (sessionUnsubscribe) {
                    sessionUnsubscribe(); // Leave previous session
                }
                
                currentSessionId = sessionId;
                console.log("Joining session:", sessionId);

                // Update UI
                const shareUrl = new URL(window.location.href);
                shareUrl.searchParams.set('session', sessionId);
                document.getElementById('share-link-input').value = shareUrl.href;
                document.getElementById('share-info-box').classList.remove('hidden');
                document.getElementById('start-share-btn').classList.add('hidden');

                const sessionRef = window.firebase.doc(db, 'artifacts', appId, 'public', 'data', 'graphing-sessions', sessionId);

                // Listen for updates
                sessionUnsubscribe = window.firebase.onSnapshot(sessionRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.senderId !== userId) { // Don't react to our own changes
                            console.log("Received update from firestore:", data);
                            isUpdatingFromFirestore = true;
                            
                            // Apply graph state
                            if (data.graphState) {
                                setGrapherState(data.graphState);
                            }
                            
                            // Apply camera state
                            if (data.cameraState && grapherCamera && grapherMesh) {
                                grapherCamera.position.fromArray(data.cameraState.position);
                                grapherMesh.rotation.set(data.cameraState.rotation[0], data.cameraState.rotation[1], data.cameraState.rotation[2]);
                                grapherCamera.lookAt(0, 0, 0); // Re-orient camera
                            }

                            isUpdatingFromFirestore = false;
                        }
                    }
                });

                // Send initial state
                sendUpdateToFirestore();
            }

            // Leaves the current session
            function leaveShareSession() {
                if (sessionUnsubscribe) {
                    sessionUnsubscribe();
                    sessionUnsubscribe = null;
                }
                currentSessionId = null;
                document.getElementById('share-info-box').classList.add('hidden');
                document.getElementById('start-share-btn').classList.remove('hidden');
                console.log("Left sharing session.");
            }

            // Sends an update to Firestore
            async function sendUpdateToFirestore(cameraState = null) {
                if (isUpdatingFromFirestore || !currentSessionId) return;

                const sessionRef = window.firebase.doc(db, 'artifacts', appId, 'public', 'data', 'graphing-sessions', currentSessionId);
                
                const dataToSend = {
                    senderId: userId,
                    timestamp: Date.now()
                };

                if (cameraState) {
                    dataToSend.cameraState = cameraState;
                } else {
                    dataToSend.graphState = getGrapherState();
                }

                try {
                    await window.firebase.setDoc(sessionRef, dataToSend, { merge: true });
                } catch (err) {
                    console.error("Error sending update to Firestore:", err);
                }
            }

            // Copies the share link to clipboard
            function copyShareLink() {
                const input = document.getElementById('share-link-input');
                input.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error("Failed to copy link:", err);
                }
            }

            // --- END Firebase Functions ---

            // --- Global State & Charts ---
            let algebraChart2D = null;
            let polynomialChart = null;
            let calcChart = null;
            let integralChart = null;
            let trigChart = null;
            
            // 3D Algebra
            let threeScene, threeCamera, threeRenderer, threeGroup;
            // 3D Grapher
            let grapherScene, grapherCamera, grapherRenderer, grapherMesh;
            let grapherMode = 'explicit'; // NEW: Grapher mode
            // NEW: 3D Vector Lab
            let vectorScene, vectorCamera, vectorRenderer, vectorGroup;


            let currentModule = 'algebra';
            let currentAlgebraTab = 'algebra-system-solver';
            let currentCalcTab = 'calc-graph';
            let currentTrigTab = 'trig-unit-circle';

            // --- Wait for Firebase before initializing app ---
            await initFirebase();
            checkUrlForSession();

            // --- DOM Elements ---
            const modules = {
                algebra: document.getElementById('algebra-module'),
                calculus: document.getElementById('calculus-module'),
                trig: document.getElementById('trig-module'),
                'vector-lab': document.getElementById('vector-lab-module'), // NEW
                '3d-grapher': document.getElementById('3d-grapher-module'),
                'ai-tutor': document.getElementById('ai-tutor-module'),
            };
            const navButtons = document.querySelectorAll('.nav-btn');
            const mobileNav = document.getElementById('mobile-nav');

            // --- Main Navigation ---
            function switchModule(moduleName) {
                currentModule = moduleName;
                // Hide all modules
                Object.values(modules).forEach(mod => mod.classList.add('hidden'));
                // Show selected module
                if (modules[moduleName]) {
                    modules[moduleName].classList.remove('hidden');
                }
                // Update nav button styles
                navButtons.forEach(btn => {
                    if (btn.dataset.module === moduleName) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                    }
                });
                mobileNav.value = moduleName;

                // Initialize 3D scenes when switched to
                if (moduleName === '3d-grapher') {
                    initThreeJSGrapher();
                } else if (moduleName === 'vector-lab') { // NEW
                    initThreeJSVectorLab();
                } else if (moduleName === 'trig') { // NEW: Init trig chart
                    initTrigChart();
                }
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => switchModule(btn.dataset.module));
            });
            mobileNav.addEventListener('change', (e) => switchModule(e.target.value));

            // ===================================================================
            // MODULE 1: ALGEBRA SOLVER
            // ===================================================================
            const algebraTabButtons = document.querySelectorAll('.algebra-tab-btn');
            const btn2Vars = document.getElementById('btn-2-vars');
            const btn3Vars = document.getElementById('btn-3-vars');
            const inputs2Vars = document.getElementById('inputs-2-vars');
            const inputs3Vars = document.getElementById('inputs-3-vars');
            const chart2DContainer = document.getElementById('chart-2d-container');
            const chart3DContainer = document.getElementById('chart-3d-container');
            const solveAlgebraBtn = document.getElementById('solve-algebra');
            const algebraSolution = document.getElementById('algebra-solution');
            const algebraSteps = document.getElementById('algebra-steps');
            const explainAlgebraBtn = document.getElementById('explain-algebra-btn');
            let algebraVarMode = 2;

            // --- Algebra Tab Controls ---
            algebraTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentAlgebraTab = btn.dataset.tab;
                    // Update button styles
                    algebraTabButtons.forEach(b => {
                        b.classList.toggle('border-b-2', b.dataset.tab === currentAlgebraTab);
                        b.classList.toggle('border-blue-500', b.dataset.tab === currentAlgebraTab);
                        b.classList.toggle('text-white', b.dataset.tab === currentAlgebraTab);
                        b.classList.toggle('text-gray-400', b.dataset.tab !== currentAlgebraTab);
                    });
                    // Show/hide content
                    document.querySelectorAll('.algebra-tab-content').forEach(content => {
                        content.classList.toggle('hidden', content.id !== currentAlgebraTab);
                    });
                    
                    // Run default logic for the selected tab
                    if (currentAlgebraTab === 'algebra-system-solver') {
                        solve2VarSystem(); // Run default
                    } else if (currentAlgebraTab === 'algebra-polynomial-roots') {
                        solvePolynomial(); // Run default
                    }
                });
            });
            document.querySelector('.algebra-tab-btn[data-tab="algebra-system-solver"]')?.click();


            // --- Sub-Tab: System Solver ---
            btn2Vars.addEventListener('click', () => {
                algebraVarMode = 2;
                inputs2Vars.classList.remove('hidden');
                inputs3Vars.classList.add('hidden');
                chart2DContainer.classList.remove('hidden');
                chart3DContainer.classList.add('hidden');
                btn2Vars.classList.add('bg-blue-600');
                btn2Vars.classList.remove('bg-gray-600');
                btn3Vars.classList.add('bg-gray-600');
                btn3Vars.classList.remove('bg-blue-600');
                explainAlgebraBtn.classList.add('hidden');
            });

            btn3Vars.addEventListener('click', () => {
                algebraVarMode = 3;
                inputs2Vars.classList.add('hidden');
                inputs3Vars.classList.remove('hidden');
                chart2DContainer.classList.add('hidden');
                chart3DContainer.classList.remove('hidden');
                btn3Vars.classList.add('bg-blue-600');
                btn3Vars.classList.remove('bg-gray-600');
                btn2Vars.classList.add('bg-gray-600');
                btn2Vars.classList.remove('bg-blue-600');
                initThreeJS(); // Initialize 3D canvas if not already
                explainAlgebraBtn.classList.add('hidden');
            });
            
            solveAlgebraBtn.addEventListener('click', () => {
                if (algebraVarMode === 2) {
                    solve2VarSystem();
                } else {
                    solve3VarSystem();
                }
                explainAlgebraBtn.classList.remove('hidden');
            });

            function solve2VarSystem() {
                try {
                    const [a1, b1, d1] = ['a1', 'b1', 'd1'].map(id => parseFloat(document.getElementById(id).value));
                    const [a2, b2, d2] = ['a2', 'b2', 'd2'].map(id => parseFloat(document.getElementById(id).value));
                    const A = math.matrix([[a1, b1], [a2, b2]]);
                    const D = math.det(A);
                    const Dx = math.det([[d1, b1], [d2, b2]]);
                    const Dy = math.det([[a1, d1], [a2, d2]]);
                    
                    if (D === 0) {
                        algebraSolution.textContent = 'No unique solution.';
                        algebraSteps.textContent = `Determinant (D) = ${D}\nSystem is either inconsistent (no solution) or dependent (infinite solutions).`;
                        if(algebraChart2D) algebraChart2D.destroy();
                        return;
                    }
                    const x = Dx / D;
                    const y = Dy / D;
                    algebraSolution.textContent = `Solution: x = ${math.format(x, {precision: 4})}, y = ${math.format(y, {precision: 4})}`;
                    algebraSteps.textContent = `Using Cramer's Rule:\n\n`
                        + `1. Main Determinant (D):\n    | ${a1}  ${b1} |\n    | ${a2}  ${b2} | = ${D}\n\n`
                        + `2. Dx Determinant:\n    | ${d1}  ${b1} |\n    | ${d2}  ${b2} | = ${Dx}\n\n`
                        + `3. Dy Determinant:\n    | ${a1}  ${d1} |\n    | ${a2}  ${d2} | = ${Dy}\n\n`
                        + `4. Solve:\n    x = Dx / D = ${x}\n    y = Dy / D = ${y}`;
                    visualize2DSystem(a1, b1, d1, a2, b2, d2, x, y);
                } catch (err) {
                    algebraSolution.textContent = 'Error solving system.';
                    algebraSteps.textContent = err.message;
                }
            }

            function visualize2DSystem(a1, b1, d1, a2, b2, d2, solX, solY) {
                const ctx = document.getElementById('algebra-chart-2d').getContext('2d');
                if (algebraChart2D) algebraChart2D.destroy();
                const line1Data = [], line2Data = [];
                const range = 10, minX = solX - range, maxX = solX + range;
                for (let x = minX; x <= maxX; x += 0.5) {
                    if (b1 !== 0) line1Data.push({ x: x, y: (d1 - a1 * x) / b1 });
                    if (b2 !== 0) line2Data.push({ x: x, y: (d2 - a2 * x) / b2 });
                }
                if (b1 === 0) line1Data.push({x: d1/a1, y: solY - range}, {x: d1/a1, y: solY + range});
                if (b2 === 0) line2Data.push({x: d2/a2, y: solY - range}, {x: d2/a2, y: solY + range});

                algebraChart2D = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            { label: `Line 1: ${a1}x + ${b1}y = ${d1}`, data: line1Data, showLine: true, borderColor: 'rgb(59, 130, 246)', tension: 0.1, pointRadius: 0 },
                            { label: `Line 2: ${a2}x + ${b2}y = ${d2}`, data: line2Data, showLine: true, borderColor: 'rgb(234, 179, 8)', tension: 0.1, pointRadius: 0 },
                            { label: 'Solution', data: [{ x: solX, y: solY }], backgroundColor: 'rgb(248, 113, 113)', pointRadius: 6 }
                        ]
                    },
                    options: chartOptions2D()
                });
            }

            function solve3VarSystem() {
                try {
                    const [a1, b1, c1, d1] = ['a3', 'b3', 'c3', 'd3'].map(id => parseFloat(document.getElementById(id).value));
                    const [a2, b2, c2, d2] = ['a4', 'b4', 'c4', 'd4'].map(id => parseFloat(document.getElementById(id).value));
                    const [a3, b3, c3, d3] = ['a5', 'b5', 'c5', 'd5'].map(id => parseFloat(document.getElementById(id).value));
                    const A = math.matrix([[a1, b1, c1], [a2, b2, c2], [a3, b3, c3]]);
                    const D = math.det(A);
                    const Dx = math.det([[d1, b1, c1], [d2, b2, c2], [d3, b3, c3]]);
                    const Dy = math.det([[a1, d1, c1], [a2, d2, c2], [a3, d3, c3]]);
                    const Dz = math.det([[a1, b1, d1], [a2, b2, d2], [a3, b3, d3]]);
                    if (D === 0) {
                        algebraSolution.textContent = 'No unique solution.';
                        algebraSteps.textContent = `Determinant (D) = ${D}\nSystem is either inconsistent or dependent.`;
                        clearThreeScene(); return;
                    }
                    const x = Dx / D, y = Dy / D, z = Dz / D;
                    algebraSolution.textContent = `Solution: x = ${math.format(x, 4)}, y = ${math.format(y, 4)}, z = ${math.format(z, 4)}`;
                    algebraSteps.textContent = `Using Cramer's Rule (3x3):\n\n`
                        + `1. Main Determinant (D) = ${D}\n`
                        + `2. Dx Determinant = ${Dx}\n... (etc.) ...\n`
                        + `5. Solve:\n    x = Dx / D = ${x}\n    y = Dy / D = ${y}\n    z = Dz / D = ${z}`;
                    visualize3DSystem({a: a1, b: b1, c: c1, d: d1}, {a: a2, b: b2, c: c2, d: d2}, {a: a3, b: b3, c: c3, d: d3}, {x, y, z});
                } catch (err) {
                    algebraSolution.textContent = 'Error solving system.';
                    algebraSteps.textContent = err.message;
                }
            }

            // --- Three.js 3D Visualization (Algebra) ---
            function initThreeJS() {
                if (threeScene) return; // Already initialized
                const container = document.getElementById('three-canvas');
                threeScene = new THREE.Scene();
                threeCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                threeRenderer = new THREE.WebGLRenderer({ antialias: true });
                threeRenderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(threeRenderer.domElement);
                threeGroup = new THREE.Group();
                threeScene.add(threeGroup);
                threeCamera.position.z = 10;
                const axesHelper = new THREE.AxesHelper(10);
                threeScene.add(axesHelper);
                let isDragging = false, prevPos = { x: 0, y: 0 };
                container.addEventListener('mousedown', (e) => isDragging = true);
                container.addEventListener('mouseup', () => isDragging = false);
                container.addEventListener('mouseleave', () => isDragging = false);
                container.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    threeGroup.rotation.y += (e.offsetX - prevPos.x) * 0.01;
                    threeGroup.rotation.x += (e.offsetY - prevPos.y) * 0.01;
                    prevPos = { x: e.offsetX, y: e.offsetY };
                });
                container.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    threeCamera.position.z = Math.max(5, Math.min(50, threeCamera.position.z + e.deltaY * 0.01));
                });
                new ResizeObserver(() => {
                    if (!threeRenderer || !threeCamera) return;
                    threeCamera.aspect = container.clientWidth / container.clientHeight;
                    threeCamera.updateProjectionMatrix();
                    threeRenderer.setSize(container.clientWidth, container.clientHeight);
                }).observe(container);
                animateThreeJS();
            }
            function animateThreeJS() {
                if (!threeRenderer) return;
                requestAnimationFrame(animateThreeJS);
                threeRenderer.render(threeScene, threeCamera);
            }
            function clearThreeScene() {
                if (!threeGroup) return;
                while (threeGroup.children.length > 0) threeGroup.remove(threeGroup.children[0]);
            }
            function createPlane(eq, color) {
                const { a, b, c, d } = eq;
                const normal = new THREE.Vector3(a, b, c).normalize();
                const planeGeom = new THREE.PlaneGeometry(15, 15);
                const planeMat = new THREE.MeshBasicMaterial({ color, opacity: 0.5, transparent: true, side: THREE.DoubleSide });
                const plane = new THREE.Mesh(planeGeom, planeMat);
                let pointOnPlane;
                if (c !== 0) pointOnPlane = new THREE.Vector3(0, 0, d / c);
                else if (b !== 0) pointOnPlane = new THREE.Vector3(0, d / b, 0);
                else if (a !== 0) pointOnPlane = new THREE.Vector3(d / a, 0, 0);
                else return null;
                plane.position.copy(pointOnPlane);
                plane.lookAt(pointOnPlane.clone().add(normal));
                return plane;
            }
            function visualize3DSystem(eq1, eq2, eq3, sol) {
                if (!threeScene) initThreeJS();
                clearThreeScene();
                [createPlane(eq1, 0xff0000), createPlane(eq2, 0x00ff00), createPlane(eq3, 0x0000ff)].forEach(p => p && threeGroup.add(p));
                const solGeom = new THREE.SphereGeometry(0.2, 32, 32);
                const solMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                const solSphere = new THREE.Mesh(solGeom, solMat);
                solSphere.position.set(sol.x, sol.y, sol.z);
                threeGroup.add(solSphere);
                threeGroup.position.set(-sol.x, -sol.y, -sol.z);
            }

            // --- Sub-Tab: Polynomial Roots ---
            const solvePolyBtn = document.getElementById('solve-poly');
            const polySolution = document.getElementById('poly-solution');
            const polySteps = document.getElementById('poly-steps');
            const explainPolyBtn = document.getElementById('explain-poly-btn');
            
            solvePolyBtn.addEventListener('click', solvePolynomial);

            function solvePolynomial() {
                try {
                    const [a, b, c, d] = ['poly-a', 'poly-b', 'poly-c', 'poly-d'].map(id => parseFloat(document.getElementById(id).value) || 0);
                    if (a === 0) {
                        polySolution.textContent = 'This is not a cubic polynomial (a=0).';
                        polySteps.textContent = 'Please enter a non-zero value for "a".';
                        if(polynomialChart) polynomialChart.destroy();
                        explainPolyBtn.classList.add('hidden'); return;
                    }
                    const roots = math.polynomialRoot(d, c, b, a);
                    polySolution.textContent = 'Roots found:';
                    polySteps.innerHTML = roots.map((root, i) => `Root ${i+1}: ${math.format(root, {precision: 5})}`).join('\n');
                    graphPolynomial(a, b, c, d, roots);
                    explainPolyBtn.classList.remove('hidden');
                } catch (err) {
                    polySolution.textContent = 'Error finding roots.';
                    polySteps.textContent = err.message;
                    explainPolyBtn.classList.add('hidden');
                }
            }

            function graphPolynomial(a, b, c, d, roots) {
                const funcData = [], rootData = [];
                const polyFunc = (x) => a*x**3 + b*x**2 + c*x + d;
                const realRoots = roots.filter(r => math.im(r) === 0).map(r => math.re(r));
                let minX = -10, maxX = 10;
                if (realRoots.length > 0) {
                    minX = Math.min(...realRoots) - 5;
                    maxX = Math.max(...realRoots) + 5;
                }
                for (let x = minX; x <= maxX; x += (maxX - minX) / 100) funcData.push({ x: x, y: polyFunc(x) });
                realRoots.forEach(root => rootData.push({ x: root, y: 0 }));

                const ctx = document.getElementById('poly-chart').getContext('2d');
                if (polynomialChart) polynomialChart.destroy();
                polynomialChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            { label: `f(x) = ${a}xÂ³...`, data: funcData, showLine: true, borderColor: 'rgb(59, 130, 246)', tension: 0.1, pointRadius: 0 },
                            { label: 'Real Roots', data: rootData, backgroundColor: 'rgb(248, 113, 113)', pointRadius: 6 }
                        ]
                    },
                    options: chartOptions2D()
                });
            }

            // --- Sub-Tab: Matrix Calculator ---
            const matrixOpButtons = document.querySelectorAll('.matrix-op-btn');
            const matrixResultGrid = document.getElementById('matrix-result-grid');
            const matrixResultScalar = document.getElementById('matrix-result-scalar');
            const matrixResultCells = document.querySelectorAll('.matrix-result-cell');
            const matrixError = document.getElementById('matrix-error');
            const explainMatrixBtn = document.getElementById('explain-matrix-btn');
            let lastMatrixOp = '';

            function readMatrix(prefix) {
                const m = [];
                for (let r = 0; r < 3; r++) {
                    const row = [];
                    for (let c = 0; c < 3; c++) row.push(parseFloat(document.getElementById(`${prefix}-${r}${c}`).value));
                    m.push(row);
                }
                return math.matrix(m);
            }
            function displayMatrix(m) {
                const data = m.toArray();
                let i = 0;
                for (let r = 0; r < 3; r++) for (let c = 0; c < 3; c++) matrixResultCells[i++].textContent = math.format(data[r][c], {precision: 4});
            }

            matrixOpButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    matrixError.textContent = ''; matrixResultScalar.textContent = '';
                    matrixResultGrid.classList.add('hidden');
                    explainMatrixBtn.classList.add('hidden');
                    lastMatrixOp = btn.dataset.op;
                    try {
                        const A = readMatrix('A'), B = readMatrix('B'), op = btn.dataset.op;
                        let result, det;
                        switch (op) {
                            case 'add': result = math.add(A, B); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'subtract': result = math.subtract(A, B); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'multiply': result = math.multiply(A, B); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'detA': result = math.det(A); matrixResultScalar.textContent = `det(A) = ${math.format(result, 4)}`; break;
                            case 'invA': result = math.inv(A); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'adjA': det = math.det(A); if (Math.abs(det) < 1e-9) throw new Error("Singular matrix"); result = math.multiply(math.inv(A), det); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'detB': result = math.det(B); matrixResultScalar.textContent = `det(B) = ${math.format(result, 4)}`; break;
                            case 'invB': result = math.inv(B); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                            case 'adjB': det = math.det(B); if (Math.abs(det) < 1e-9) throw new Error("Singular matrix"); result = math.multiply(math.inv(B), det); matrixResultGrid.classList.remove('hidden'); displayMatrix(result); break;
                        }
                        explainMatrixBtn.classList.remove('hidden');
                    } catch (err) {
                        matrixError.textContent = `Error: ${err.message}`;
                    }
                });
            });


            // ===================================================================
            // MODULE 2: CALCULUS LAB
            // ===================================================================
            const calcFunctionInput = document.getElementById('calc-function');
            const calcUpdateBtn = document.getElementById('calc-update-all');
            const calcTabButtons = document.querySelectorAll('.calc-tab-btn');
            const explainDerivativeBtn = document.getElementById('explain-derivative-btn');
            const explainIntegralBtn = document.getElementById('explain-integral-btn');
            const explainLimitBtn = document.getElementById('explain-limit-btn');
            const aiAnalyzeCalcBtn = document.getElementById('ai-analyze-calc-btn'); // NEW

            // Tab Controls
            calcTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCalcTab = btn.dataset.tab;
                    calcTabButtons.forEach(b => {
                        b.classList.toggle('border-b-2', b.dataset.tab === currentCalcTab);
                        b.classList.toggle('border-blue-500', b.dataset.tab === currentCalcTab);
                        b.classList.toggle('text-white', b.dataset.tab === currentCalcTab);
                        b.classList.toggle('text-gray-400', b.dataset.tab !== currentCalcTab);
                    });
                    document.querySelectorAll('.calc-tab-content').forEach(c => c.classList.toggle('hidden', c.id !== currentCalcTab));
                    updateCalculusModule(); 
                });
            });
            document.querySelector('.calc-tab-btn[data-tab="calc-graph"]')?.click();

            calcUpdateBtn.addEventListener('click', updateCalculusModule);
            
            // Integral slider
            const integralN = document.getElementById('integral-n'), integralNLabel = document.getElementById('integral-n-label');
            integralN.addEventListener('input', () => {
                integralNLabel.textContent = integralN.value;
                if (currentCalcTab === 'calc-integral') drawRiemannSum();
            });
            ['integral-a', 'integral-b', 'limit-a'].forEach(id => document.getElementById(id).addEventListener('change', updateCalculusModule));

            function updateCalculusModule() {
                const fx = calcFunctionInput.value;
                if (!fx) return;
                switch (currentCalcTab) {
                    case 'calc-graph': updateCalcGraph(fx); break;
                    case 'calc-derivative': updateDerivative(fx); break;
                    case 'calc-integral': drawRiemannSum(fx); break;
                    case 'calc-limit': updateLimitTable(fx); break;
                }
            }
            function parseFunction(fx) {
                try { return math.parse(fx).compile(); }
                catch (e) { console.error("Error parsing function:", e); return null; }
            }
            function updateCalcGraph(fx) {
                const code = parseFunction(fx); if (!code) return;
                const data = [];
                for (let x = -10; x <= 10; x += 0.25) try { data.push({ x: x, y: code.evaluate({ x: x }) }); } catch (e) {}
                const ctx = document.getElementById('calc-chart').getContext('2d');
                if (calcChart) calcChart.destroy();
                calcChart = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets: [{ label: `f(x) = ${fx}`, data, showLine: true, borderColor: 'rgb(59, 130, 246)', tension: 0.1, pointRadius: 0 }] },
                    options: chartOptions2D()
                });
            }
            function updateDerivative(fx) {
                try {
                    const derivative = math.derivative(fx, 'x');
                    document.getElementById('deriv-fx').textContent = fx;
                    document.getElementById('deriv-fpx').textContent = derivative.toString();
                } catch (err) {
                    document.getElementById('deriv-fpx').textContent = `Error: ${err.message}`;
                }
            }
            function drawRiemannSum(fxOverride) {
                const fx = fxOverride || calcFunctionInput.value;
                const code = parseFunction(fx); if (!code) return;
                const a = parseFloat(document.getElementById('integral-a').value), b = parseFloat(document.getElementById('integral-b').value), n = parseInt(integralN.value);
                const dx = (b - a) / n; let totalArea = 0;
                const funcData = [], barData = [];
                for (let i = 0; i < n; i++) {
                    const x_mid = a + (i + 0.5) * dx;
                    try { const y = code.evaluate({ x: x_mid }); if (!isNaN(y) && isFinite(y)) { totalArea += y * dx; barData.push({ x: x_mid, y }); } } catch (e) {}
                }
                for (let x = a; x <= b; x += (b - a) / 100) try { funcData.push({ x: x, y: code.evaluate({ x: x }) }); } catch (e) {}
                document.getElementById('integral-area').textContent = math.format(totalArea, 5);
                explainIntegralBtn.classList.remove('hidden');
                const ctx = document.getElementById('integral-chart').getContext('2d');
                if (integralChart) integralChart.destroy();
                integralChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        datasets: [
                            { label: 'Function', data: funcData, type: 'line', borderColor: 'rgb(234, 179, 8)', pointRadius: 0, order: 1 },
                            { label: 'Rectangles (Midpoint)', data: barData.map(p => ({x: p.x, y: p.y})), backgroundColor: 'rgba(59, 130, 246, 0.5)', barPercentage: 1.0, categoryPercentage: 1.0, order: 2 }
                        ]
                    },
                    options: chartOptions2D(true)
                });
            }
            function updateLimitTable(fx) {
                const code = parseFunction(fx); if (!code) return;
                const a = parseFloat(document.getElementById('limit-a').value);
                document.getElementById('limit-fx').textContent = `f(x) = ${fx}`;
                const leftTable = document.getElementById('limit-table-left'), rightTable = document.getElementById('limit-table-right');
                leftTable.innerHTML = ''; rightTable.innerHTML = '';
                const deltas = [0.1, 0.01, 0.001, 0.0001]; let lastLeftY, lastRightY;
                deltas.forEach(delta => {
                    let x_left = a - delta, y_left = '...'; try { y_left = code.evaluate({ x: x_left }); lastLeftY = y_left; } catch (e) {}
                    let x_right = a + delta, y_right = '...'; try { y_right = code.evaluate({ x: x_right }); lastRightY = y_right; } catch (e) {}
                    leftTable.innerHTML += `<tr class="border-t border-gray-700"><td class="p-2">${x_left}</td><td class="p-2">${math.format(y_left, 5)}</td></tr>`;
                    rightTable.innerHTML += `<tr class="border-t border-gray-700"><td class="p-2">${x_right}</td><td class="p-2">${math.format(y_right, 5)}</td></tr>`;
                });
                let limitVal = '...';
                if (Math.abs(lastLeftY - lastRightY) < 1e-4) limitVal = math.format(lastRightY, 5);
                else if (lastLeftY === Infinity || lastRightY === Infinity) limitVal = 'âˆž';
                else if (lastLeftY === -Infinity || lastRightY === -Infinity) limitVal = '-âˆž';
                else limitVal = 'Does Not Exist (DNE)';
                document.getElementById('limit-value').textContent = limitVal;
                explainLimitBtn.classList.remove('hidden');
            }
            function chartOptions2D(isIntegral = false) {
                return {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', grid: { color: '#4a5568' }, ticks: { color: '#d1d5db' }, barThickness: 'flex' },
                        y: { grid: { color: '#4a5568' }, ticks: { color: '#d1d5db' }, beginAtZero: isIntegral }
                    },
                    plugins: { legend: { labels: { color: '#d1d5db' } } }
                };
            }

            // ===================================================================
            // MODULE 3: TRIG HUB
            // ===================================================================
            const trigTabButtons = document.querySelectorAll('.trig-tab-btn');
            const solveTriangleBtn = document.getElementById('solve-triangle');
            const explainTrigBtn = document.getElementById('explain-trig-btn');

            // --- Unit Circle DOM Elements (Moved for initialization) ---
            const svg = document.getElementById('unit-circle-svg'), handle = document.getElementById('unit-circle-handle');
            const hyp = document.getElementById('unit-hypotenuse'), opp = document.getElementById('unit-opposite'), adj = document.getElementById('unit-adjacent');
            const arc = document.getElementById('unit-angle-arc');
            const sinLabel = document.getElementById('sin-label'), cosLabel = document.getElementById('cos-label');
            const degInput = document.getElementById('uc-angle-deg-input'), radInput = document.getElementById('uc-angle-rad-input');
            
            // --- Unit Circle Globals ---
            const radius = 120, center = 150; 
            let ucIsDragging = false;
            let currentAngleRad = 0; // NEW: Global state for angle

            // Tab Controls
            trigTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTrigTab = btn.dataset.tab;
                    trigTabButtons.forEach(b => {
                        b.classList.toggle('border-b-2', b.dataset.tab === currentTrigTab);
                        b.classList.toggle('border-blue-500', b.dataset.tab === currentTrigTab);
                        b.classList.toggle('text-white', b.dataset.tab === currentTrigTab);
                        b.classList.toggle('text-gray-400', b.dataset.tab !== currentTrigTab);
                    });
                    document.querySelectorAll('.trig-tab-content').forEach(c => c.classList.toggle('hidden', c.id !== currentTrigTab));
                    if (currentTrigTab === 'trig-unit-circle') {
                        initTrigChart();
                    }
                });
            });
            document.querySelector('.trig-tab-btn[data-tab="trig-unit-circle"]')?.click();

            // --- Unit Circle Logic ---
            // const svg = document.getElementById('unit-circle-svg'), handle = document.getElementById('unit-circle-handle'); // MOVED UP
            // const hyp = document.getElementById('unit-hypotenuse'), opp = document.getElementById('unit-opposite'), adj = document.getElementById('unit-adjacent'); // MOVED UP
            // const arc = document.getElementById('unit-angle-arc'); // MOVED UP
            // const sinLabel = document.getElementById('sin-label'), cosLabel = document.getElementById('cos-label'); // MOVED UP
            // const degInput = document.getElementById('uc-angle-deg-input'), radInput = document.getElementById('uc-angle-rad-input'); // MOVED UP
            // const radius = 120, center = 150; // MOVED UP
            // let ucIsDragging = false; // MOVED UP
            // let currentAngleRad = 0; // NEW: Global state for angle // MOVED UP

            svg.addEventListener('mousedown', (e) => { ucIsDragging = true; updateUnitCircleFromMouse(e); });
            svg.addEventListener('mousemove', (e) => { if (ucIsDragging) updateUnitCircleFromMouse(e); });
            svg.addEventListener('mouseup', () => ucIsDragging = false);
            svg.addEventListener('mouseleave', () => ucIsDragging = false);
            svg.addEventListener('touchstart', (e) => { ucIsDragging = true; updateUnitCircleFromMouse(e.touches[0]); });
            svg.addEventListener('touchmove', (e) => { if (ucIsDragging) { e.preventDefault(); updateUnitCircleFromMouse(e.touches[0]); } });
            svg.addEventListener('touchend', () => ucIsDragging = false);
            
            degInput.addEventListener('change', () => {
                const deg = parseFloat(degInput.value);
                const rad = deg * (Math.PI / 180);
                updateUnitCircle(rad);
            });
            
            radInput.addEventListener('change', () => {
                try {
                    const rad = math.evaluate(radInput.value.replace('pi', 'PI'));
                    updateUnitCircle(rad);
                } catch (e) {
                    radInput.value = currentAngleRad.toFixed(2);
                    console.error("Invalid radian expression");
                }
            });

            function updateUnitCircleFromMouse(e) {
                const rect = svg.getBoundingClientRect();
                // Get mouse/touch position relative to SVG top-left
                const svgX = e.clientX - rect.left;
                const svgY = e.clientY - rect.top;
                // Convert to SVG coordinate system (relative to center 150,150)
                const x = svgX - center;
                const y = svgY - center;
                
                let angle = Math.atan2(y, x);
                updateUnitCircle(angle);
            }

            // NEW: Master update function
            function updateUnitCircle(angleRad) {
                currentAngleRad = angleRad; // Store the state
                
                // --- Update SVG Elements ---
                const handleX = radius * Math.cos(angleRad);
                const handleY = radius * Math.sin(angleRad);
                
                handle.setAttribute('transform', `translate(${handleX}, ${handleY})`);
                hyp.setAttribute('x2', handleX); hyp.setAttribute('y2', handleY);
                opp.setAttribute('x1', handleX); opp.setAttribute('x2', handleX); opp.setAttribute('y2', handleY);
                adj.setAttribute('x2', handleX);

                // Update arc path
                const largeArcFlag = (angleRad > Math.PI || angleRad < -Math.PI) ? (angleRad > 0 ? 1 : 0) : (angleRad > 0 ? 0 : 1);
                // Correct sweep flag: 1 for positive angle, 0 for negative
                const sweepFlag = angleRad > 0 ? 1 : 0;
                const arcD = `M ${radius} 0 A ${radius} ${radius} 0 ${largeArcFlag} ${sweepFlag} ${handleX} ${handleY} L 0 0 Z`;
                arc.setAttribute('d', arcD);

                // Update text labels
                cosLabel.setAttribute('x', handleX / 2);
                cosLabel.setAttribute('y', 12);
                sinLabel.setAttribute('x', handleX + 5);
                sinLabel.setAttribute('y', handleY / 2);

                // --- Update Trig Values ---
                const cos = Math.cos(angleRad);
                const sin = Math.sin(angleRad);
                const tan = Math.tan(angleRad);
                let deg = angleRad * (180 / Math.PI);
                
                // Normalize degrees to 0-360
                const normalizedDeg = ((deg % 360) + 360) % 360;

                // --- Update Text and Input Fields ---
                degInput.value = normalizedDeg.toFixed(1);
                radInput.value = angleRad.toFixed(3); // Update input field
                
                document.getElementById('uc-cos').textContent = cos.toFixed(3);
                document.getElementById('uc-sin').textContent = sin.toFixed(3);
                
                // Handle tan(undefined)
                if (Math.abs(cos) < 1e-9) {
                    document.getElementById('uc-tan').textContent = "Undefined";
                } else {
                    document.getElementById('uc-tan').textContent = tan.toFixed(3);
                }

                // Update the separate sine/cosine chart
                updateTrigChart(angleRad);
            }
            
            function initTrigChart() {
                if (trigChart) return; // Already initialized
                
                const ctx = document.getElementById('trig-chart').getContext('2d');
                const sinData = [], cosData = [];
                for (let x = -2 * Math.PI; x <= 2 * Math.PI; x += 0.1) { 
                    sinData.push({x, y: Math.sin(x)}); 
                    cosData.push({x, y: Math.cos(x)}); 
                }
                trigChart = new Chart(ctx, { 
                    type: 'scatter', 
                    data: { datasets: [
                        { label: 'sin(x)', data: sinData, showLine: true, borderColor: 'rgb(52, 211, 153)', pointRadius: 0, borderWidth: 2 },
                        { label: 'cos(x)', data: cosData, showLine: true, borderColor: 'rgb(96, 165, 250)', pointRadius: 0, borderWidth: 2 }
                    ]}, 
                    options: chartOptions2D() 
                });
                // Initialize with default angle
                updateUnitCircle(0);
            }
            
            function updateTrigChart(angle) {
                if (!trigChart) initTrigChart();
                
                // Ensure annotations plugin is registered if using one
                // For simplicity, we'll redraw a vertical line manually if no plugin
                
                // Simple vertical line annotation
                trigChart.options.plugins.annotation = {
                    annotations: {
                        line1: {
                            type: 'line',
                            xMin: angle,
                            xMax: angle,
                            borderColor: 'rgb(248, 113, 113)',
                            borderWidth: 2,
                            label: {
                                content: `Î¸ = ${angle.toFixed(2)}`,
                                enabled: true,
                                position: 'top',
                                backgroundColor: 'rgba(248, 113, 113, 0.8)'
                            }
                        }
                    }
                };
                trigChart.update();
            }
            // Init
            initTrigChart();
            updateUnitCircle(0);
            
            // --- Triangle Solver Logic ---
            solveTriangleBtn.addEventListener('click', () => {
                let a = parseFloat(document.getElementById('tri-a').value), b = parseFloat(document.getElementById('tri-b').value), c = parseFloat(document.getElementById('tri-c').value);
                let A = parseFloat(document.getElementById('tri-A').value), B = parseFloat(document.getElementById('tri-B').value), C = parseFloat(document.getElementById('tri-C').value);
                const sol = document.getElementById('triangle-solution'), steps = document.getElementById('triangle-steps');
                steps.innerHTML = '';
                const toRad = (deg) => deg * Math.PI / 180, toDeg = (rad) => rad * 180 / Math.PI;
                try {
                    if (!isNaN(a) && !isNaN(b) && !isNaN(c)) {
                        steps.innerHTML = 'Solving (SSS):\n';
                        A = toDeg(Math.acos((b*b + c*c - a*a) / (2*b*c))); steps.innerHTML += `1. Find A... A = ${A.toFixed(2)}Â°\n`;
                        B = toDeg(Math.acos((a*a + c*c - b*b) / (2*a*c))); steps.innerHTML += `2. Find B... B = ${B.toFixed(2)}Â°\n`;
                        C = 180 - A - B; steps.innerHTML += `3. Find C... C = ${C.toFixed(2)}Â°\n`;
                    } else if (!isNaN(a) && !isNaN(B) && !isNaN(c)) {
                        steps.innerHTML = 'Solving (SAS):\n';
                        const B_rad = toRad(B);
                        b = Math.sqrt(a*a + c*c - 2*a*c*Math.cos(B_rad)); steps.innerHTML += `1. Find b... b = ${b.toFixed(2)}\n`;
                        A = toDeg(Math.asin(a * Math.sin(B_rad) / b)); steps.innerHTML += `2. Find A... A = ${A.toFixed(2)}Â°\n`;
                        C = 180 - B - A; steps.innerHTML += `3. Find C... C = ${C.toFixed(2)}Â°\n`;
                    } else throw new Error('Case not implemented (try SSS or SAS).');
                    if (A+B+C > 180.1 || A+B+C < 179.9) throw new Error('Invalid triangle (angles!=180).');
                    sol.innerHTML = `<b>a:</b> ${a.toFixed(2)} <b>A:</b> ${A.toFixed(2)}Â° <br><b>b:</b> ${b.toFixed(2)} <b>B:</b> ${B.toFixed(2)}Â° <br><b>c:</b> ${c.toFixed(2)} <b>C:</b> ${C.toFixed(2)}Â°`;
                    explainTrigBtn.classList.remove('hidden');
                } catch (err) {
                    sol.textContent = 'Could not solve triangle.'; steps.textContent = err.message;
                    explainTrigBtn.classList.add('hidden');
                }
            });

            // ===================================================================
            // NEW MODULE 4: VECTOR LAB
            // ===================================================================
            const vectorCalcBtn = document.getElementById('vector-calculate-btn');
            const vectorResults = document.getElementById('vector-results');
            const vectorContainer = document.getElementById('vector-canvas');
            
            function initThreeJSVectorLab() {
                if (vectorScene) return; // Already initialized

                vectorScene = new THREE.Scene();
                vectorCamera = new THREE.PerspectiveCamera(75, vectorContainer.clientWidth / vectorContainer.clientHeight, 0.1, 1000);
                vectorRenderer = new THREE.WebGLRenderer({ antialias: true });
                vectorRenderer.setSize(vectorContainer.clientWidth, vectorContainer.clientHeight);
                vectorContainer.innerHTML = ''; // Clear
                vectorContainer.appendChild(vectorRenderer.domElement);

                vectorGroup = new THREE.Group();
                vectorScene.add(vectorGroup);
                
                // UPDATED: Set camera position further back to see all vectors
                vectorCamera.position.z = 10;
                vectorCamera.position.y = 10;
                vectorCamera.position.x = 10;
                vectorCamera.lookAt(0, 0, 0);

                const axesHelper = new THREE.AxesHelper(5);
                vectorScene.add(axesHelper);
                const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x444444);
                vectorScene.add(gridHelper);

                // Mouse controls
                let isDragging = false, prevPos = { x: 0, y: 0 };
                vectorContainer.addEventListener('mousedown', (e) => isDragging = true);
                vectorContainer.addEventListener('mouseup', () => isDragging = false);
                vectorContainer.addEventListener('mouseleave', () => isDragging = false);
                vectorContainer.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    vectorGroup.rotation.y += (e.offsetX - prevPos.x) * 0.01;
                    vectorGroup.rotation.x += (e.offsetY - prevPos.y) * 0.01;
                    prevPos = { x: e.offsetX, y: e.offsetY };
                });
                vectorContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    vectorCamera.position.z = Math.max(2, Math.min(20, vectorCamera.position.z + e.deltaY * 0.01));
                });
                new ResizeObserver(() => {
                    if (!vectorRenderer || !vectorCamera) return;
                    vectorCamera.aspect = vectorContainer.clientWidth / vectorContainer.clientHeight;
                    vectorCamera.updateProjectionMatrix();
                    vectorRenderer.setSize(vectorContainer.clientWidth, vectorContainer.clientHeight);
                }).observe(vectorContainer);

                animateVectorLab();
                vectorCalcBtn.click(); // Run default
            }

            function animateVectorLab() {
                if (!vectorRenderer) return;
                requestAnimationFrame(animateVectorLab);
                vectorRenderer.render(vectorScene, vectorCamera);
            }

            function visualizeVectors(v1, v2, crossProduct) {
                if (!vectorScene) initThreeJSVectorLab();
                
                // Clear old vectors
                while (vectorGroup.children.length > 0) vectorGroup.remove(vectorGroup.children[0]);

                const origin = new THREE.Vector3(0, 0, 0);
                
                // Vector 1 (Blue)
                const v1_three = new THREE.Vector3(v1[0], v1[1], v1[2]);
                // UPDATED: Removed fixed head size to use proportional defaults
                vectorGroup.add(new THREE.ArrowHelper(v1_three.clone().normalize(), origin, v1_three.length(), 0x3b82f6));
                
                // Vector 2 (Green)
                const v2_three = new THREE.Vector3(v2[0], v2[1], v2[2]);
                // UPDATED: Removed fixed head size to use proportional defaults
                vectorGroup.add(new THREE.ArrowHelper(v2_three.clone().normalize(), origin, v2_three.length(), 0x22c55e));

                // Cross Product (Red)
                const cross_three = new THREE.Vector3(crossProduct[0], crossProduct[1], crossProduct[2]);
                // UPDATED: Removed fixed head size to use proportional defaults
                vectorGroup.add(new THREE.ArrowHelper(cross_three.clone().normalize(), origin, cross_three.length(), 0xef4444));

                // NEW: Add "main points" (spheres) at the tips of the vectors
                const pointGeo = new THREE.SphereGeometry(0.15, 16, 16); // 0.15 radius sphere
                
                const v1_tip = new THREE.Mesh(pointGeo, new THREE.MeshBasicMaterial({ color: 0x3b82f6 }));
                v1_tip.position.copy(v1_three);
                vectorGroup.add(v1_tip);

                const v2_tip = new THREE.Mesh(pointGeo, new THREE.MeshBasicMaterial({ color: 0x22c55e }));
                v2_tip.position.copy(v2_three);
                vectorGroup.add(v2_tip);

                const cross_tip = new THREE.Mesh(pointGeo, new THREE.MeshBasicMaterial({ color: 0xef4444 }));
                cross_tip.position.copy(cross_three);
                vectorGroup.add(cross_tip);
            }

            vectorCalcBtn.addEventListener('click', () => {
                try {
                    const v1 = ['v1_x', 'v1_y', 'v1_z'].map(id => parseFloat(document.getElementById(id).value));
                    const v2 = ['v2_x', 'v2_y', 'v2_z'].map(id => parseFloat(document.getElementById(id).value));
                    
                    const dot = math.dot(v1, v2);
                    const cross = math.cross(v1, v2);
                    const magV1 = math.norm(v1);
                    const magV2 = math.norm(v2);
                    const angleRad = Math.acos(math.dot(v1, v2) / (magV1 * magV2));
                    const angleDeg = angleRad * 180 / Math.PI;

                    vectorResults.innerHTML = `
v1: [${v1.join(', ')}]
v2: [${v2.join(', ')}]
---------------------
Dot Product (v1 . v2): ${math.format(dot, 4)}
Cross Product (v1 x v2): [${cross.map(v => math.format(v, 4)).join(', ')}]
Magnitude |v1|: ${math.format(magV1, 4)}
Magnitude |v2|: ${math.format(magV2, 4)}
Angle between: ${math.format(angleDeg, 2)}Â° (${math.format(angleRad, 3)} rad)
`;
                    visualizeVectors(v1, v2, cross);
                } catch (err) {
                    vectorResults.textContent = `Error: ${err.message}`;
                }
            });


            // ===================================================================
            // MODULE 5: 3D FUNCTION GRAPHER
            // ===================================================================
            const graph3DBtn = document.getElementById('graph-3d-btn');
            const graph3DError = document.getElementById('graph-3d-error');
            const grapherContainer = document.getElementById('three-grapher-canvas');
            const aiAnalyze3DBtn = document.getElementById('ai-analyze-3d-btn'); // NEW
            // NEW: Mode toggle buttons
            const explicitBtn = document.getElementById('grapher-mode-explicit');
            const parametricBtn = document.getElementById('grapher-mode-parametric');
            const explicitInputs = document.getElementById('explicit-inputs');
            const parametricInputs = document.getElementById('parametric-inputs');

            explicitBtn.addEventListener('click', () => {
                grapherMode = 'explicit';
                explicitBtn.classList.add('tab-btn-active');
                explicitBtn.classList.remove('tab-btn-inactive');
                parametricBtn.classList.add('tab-btn-inactive');
                parametricBtn.classList.remove('tab-btn-active');
                explicitInputs.classList.remove('hidden');
                parametricInputs.classList.add('hidden');
                aiAnalyze3DBtn.classList.remove('hidden'); // Show analyze button
            });
            parametricBtn.addEventListener('click', () => {
                grapherMode = 'parametric';
                parametricBtn.classList.add('tab-btn-active');
                parametricBtn.classList.remove('tab-btn-inactive');
                explicitBtn.classList.add('tab-btn-inactive');
                explicitBtn.classList.remove('tab-btn-active');
                parametricInputs.classList.remove('hidden');
                explicitInputs.classList.add('hidden');
                aiAnalyze3DBtn.classList.add('hidden'); // Hide analyze button
                sendUpdateToFirestore(); // NEW: Sync state change
            });


            // --- START FIX: Re-ordering functions ---

            function animateThreeJSGrapher() {
                if (!grapherRenderer) return;
                requestAnimationFrame(animateThreeJSGrapher);
                grapherRenderer.render(grapherScene, grapherCamera);
            }

            function update3DGraph() {
                if (!grapherScene) initThreeJSGrapher();
                graph3DError.textContent = '';
                
                // Remove old mesh
                if (grapherMesh) {
                    grapherScene.remove(grapherMesh);
                    grapherMesh.geometry.dispose();
                    grapherMesh.material.dispose();
                }

                try {
                    let geometry;
                    if (grapherMode === 'explicit') {
                        // --- EXPLICIT LOGIC z = f(x, y) ---
                        const fx = document.getElementById('3d-function').value;
                        const code = math.parse(fx).compile();
                        const range = 10, segments = 50;
                        geometry = new THREE.PlaneGeometry(range * 2, range * 2, segments, segments);
                        const vertices = geometry.attributes.position.array;
                        for (let i = 0; i < vertices.length; i += 3) {
                            const x = vertices[i], y = vertices[i + 1];
                            let z = 0;
                            try { z = code.evaluate({ x, y }); } catch (e) {}
                            if (!isFinite(z)) z = 0;
                            vertices[i + 2] = z;
                        }
                        geometry.computeVertexNormals();
                        geometry.rotateX(-Math.PI / 2); // Orient plane
                    } else {
                        // --- PARAMETRIC LOGIC (x,y,z)(u,v) ---
                        const xFunc = math.parse(document.getElementById('3d-func-x').value).compile();
                        const yFunc = math.parse(document.getElementById('3d-func-y').value).compile();
                        const zFunc = math.parse(document.getElementById('3d-func-z').value).compile();
                        
                        const parametricFunction = (u, v, target) => {
                            const scope = { u, v, PI: Math.PI };
                            let x = 0, y = 0, z = 0;
                            try { x = xFunc.evaluate(scope); } catch(e) {}
                            try { y = yFunc.evaluate(scope); } catch(e) {}
                            try { z = zFunc.evaluate(scope); } catch(e) {}
                            target.set(x, y, z);
                        };
                        
                        geometry = new THREE.ParametricGeometry(parametricFunction, 50, 50);
                    }
                    
                    const material = new THREE.MeshNormalMaterial({ side: THREE.DoubleSide });
                    grapherMesh = new THREE.Mesh(geometry, material);
                    grapherScene.add(grapherMesh);
                    grapherCamera.lookAt(0, 0, 0);
                    
                } catch (e) {
                    graph3DError.textContent = `Error: ${e.message}`;
                }
            }

            function initThreeJSGrapher() {
                if (grapherScene) return; // Already initialized
                grapherScene = new THREE.Scene();
                grapherCamera = new THREE.PerspectiveCamera(75, grapherContainer.clientWidth / grapherContainer.clientHeight, 0.1, 1000);
                grapherRenderer = new THREE.WebGLRenderer({ antialias: true });
                grapherRenderer.setSize(grapherContainer.clientWidth, grapherContainer.clientHeight);
                grapherContainer.innerHTML = ''; // Clear
                grapherContainer.appendChild(grapherRenderer.domElement);
                grapherCamera.position.set(10, 10, 10);
                grapherCamera.lookAt(0, 0, 0);
                const axesHelper = new THREE.AxesHelper(10);
                grapherScene.add(axesHelper);
                const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
                grapherScene.add(gridHelper);
                let isDragging = false, prevPos = { x: 0, y: 0 };
                grapherContainer.addEventListener('mousedown', (e) => isDragging = true);
                grapherContainer.addEventListener('mouseup', () => isDragging = false);
                grapherContainer.addEventListener('mouseleave', () => isDragging = false);
                grapherContainer.addEventListener('mousemove', (e) => {
                    if (!isDragging || !grapherMesh) return;
                    grapherMesh.rotation.y += (e.offsetX - prevPos.x) * 0.01;
                    grapherMesh.rotation.x += (e.offsetY - prevPos.y) * 0.01;
                    prevPos = { x: e.offsetX, y: e.offsetY };

                    // NEW: Throttle camera sync
                    const now = Date.now();
                    if (now - lastCameraUpdate > DEBOUNCE_TIME) {
                        const cameraState = {
                            position: grapherCamera.position.toArray(),
                            rotation: [grapherMesh.rotation.x, grapherMesh.rotation.y, grapherMesh.rotation.z]
                        };
                        sendUpdateToFirestore(cameraState);
                        lastCameraUpdate = now;
                    }
                });
                grapherContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    grapherCamera.position.z = Math.max(5, Math.min(50, grapherCamera.position.z + e.deltaY * 0.01));

                    // NEW: Throttle camera sync
                    const now = Date.now();
                    if (now - lastCameraUpdate > DEBOUNCE_TIME) {
                        const cameraState = {
                            position: grapherCamera.position.toArray(),
                            rotation: [grapherMesh.rotation.x, grapherMesh.rotation.y, grapherMesh.rotation.z]
                        };
                        sendUpdateToFirestore(cameraState);
                        lastCameraUpdate = now;
                    }
                });
                new ResizeObserver(() => {
                    if (!grapherRenderer || !grapherCamera) return;
                    grapherCamera.aspect = grapherContainer.clientWidth / grapherContainer.clientHeight;
                    grapherCamera.updateProjectionMatrix();
                    grapherRenderer.setSize(grapherContainer.clientWidth, grapherContainer.clientHeight);
                }).observe(grapherContainer);
                animateThreeJSGrapher();
                update3DGraph(); // Run default
            }

            // --- END FIX ---
            
            graph3DBtn.addEventListener('click', () => {
                update3DGraph();
                sendUpdateToFirestore(); // NEW: Sync state change
            });


            // ===================================================================
            // MODULE 6: AI MATH TUTOR
            // ===================================================================
            const aiSolveBtn = document.getElementById('ai-solve-btn');
            const aiProblemInput = document.getElementById('ai-problem-input');
            const aiSolution = document.getElementById('ai-solution');
            const aiLoader = document.getElementById('ai-loader');
            const aiImageUpload = document.getElementById('ai-image-upload');
            const aiClearBtn = document.getElementById('ai-clear-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            let aiChatHistory = [];
            let uploadedImageBase64 = null;
            let uploadedMimeType = null;
            
            const systemPrompt = `You are an expert math tutor. A user will provide you with a math problem. Your task is to:
    1.  Identify the type of problem (e.g., algebra, calculus, trigonometry, etc.).
    2.  Provide a clear, detailed, step-by-step solution.
    3.  Format the solution for easy reading.
    4.  **Crucially**: Use LaTeX for all mathematical notation. Enclose inline math in single dollar signs (e.g., $f(x) = x^2$) and block-level equations in double dollar signs (e.g., $$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$).`;
            
            function clearUpload() {
                uploadedImageBase64 = null;
                uploadedMimeType = null;
                imagePreviewContainer.innerHTML = '';
                aiImageUpload.value = null;
            }
            function initAiTutor() {
                aiChatHistory = [];
                aiSolution.innerHTML = '<div class="model-message">Hello! Ask me any math question.</div>';
                clearUpload();
            }
            aiImageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImageBase64 = event.target.result;
                        uploadedMimeType = file.type;
                        imagePreviewContainer.innerHTML = `<img src="${uploadedImageBase64}" alt="Image preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            aiClearBtn.addEventListener('click', () => {
                aiProblemInput.value = '';
                initAiTutor();
            });
            function simpleMarkdown(text) {
                return text
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                    .replace(/^\* (.*)/gm, '<li>$1</li>').replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>').replace(/<\/ul>\s*<ul>/g, '')
                    .replace(/^\d+\. (.*)/gm, '<li>$1</li>').replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>').replace(/<\/ol>\s*<ol>/g, '');
            }
            function appendChatMessage(role, content, isMarkdown = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', role === 'user' ? 'user-message' : 'model-message');
                messageDiv.innerHTML = isMarkdown ? simpleMarkdown(content) : content;
                aiSolution.appendChild(messageDiv);
                aiSolution.scrollTop = aiSolution.scrollHeight;
            }
            // End re-added functions

            aiSolveBtn.addEventListener('click', () => {
                const userQuery = aiProblemInput.value;
                if (!userQuery.trim() && !uploadedImageBase64) return;
                let userMessageHTML = `${userQuery}`;
                if (uploadedImageBase64) userMessageHTML += `\n<img src="${uploadedImageBase64}" alt="User upload">`;
                appendChatMessage('user', userMessageHTML, false);
                const userParts = [{ text: userQuery }];
                if (uploadedImageBase64) userParts.push({ inlineData: { mimeType: uploadedMimeType, data: uploadedImageBase64.split(',')[1] } });
                aiChatHistory.push({ role: 'user', parts: userParts });
                aiProblemInput.value = ''; clearUpload();
                solveWithGemini();
            });

            async function solveWithGemini() {
                aiLoader.classList.remove('hidden');
                // *** API KEY UPDATED HERE ***
                const apiKey = "AIzaSyCuyAFrMmIotaXpSXD2iWnJqeIU3T3dVxk"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: aiChatHistory, systemInstruction: { parts: [{ text: systemPrompt }] } };
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error?.message || 'Unknown'}`); }
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiChatHistory.push({ role: 'model', parts: [{ text }] });
                        appendChatMessage('model', text, true);
                        if (window.MathJax) MathJax.typesetPromise([aiSolution.lastChild]).catch(console.warn);
                    } else {
                        appendChatMessage('model', 'Sorry, I could not find a solution.', false);
                    }
                } catch (err) {
                    console.error('Error calling Gemini API:', err);
                    appendChatMessage('model', `An error occurred: ${err.message}`, false);
                } finally {
                    aiLoader.classList.add('hidden');
                    aiSolution.scrollTop = aiSolution.scrollHeight;
                }
            }


            // ===================================================================
            // AI CONTEXT-AWARE BUTTONS
            // ===================================================================

            // --- Helper function to send prompt to AI ---
            function sendToAITutor(prompt) {
                aiProblemInput.value = prompt;
                if (currentModule !== 'ai-tutor') switchModule('ai-tutor');
                aiSolveBtn.click();
            }

            // --- NEW: AI Analyzer Buttons ---
            aiAnalyzeCalcBtn.addEventListener('click', () => {
                const fx = calcFunctionInput.value;
                if (!fx) return;
                const prompt = `Please perform a full analysis of the function:
\\(f(x) = ${fx}\\)

I need to know its:
1.  Domain and Range
2.  x-intercepts and y-intercept
3.  Critical points (maxima/minima)
4.  Intervals of increase/decrease
5.  Points of inflection
6.  Intervals of concavity
7.  Asymptotes (vertical, horizontal, slant), if any.
`;
                sendToAITutor(prompt);
            });
            
            aiAnalyze3DBtn.addEventListener('click', () => {
                // Only works for explicit functions
                if (grapherMode !== 'explicit') {
                    graph3DError.textContent = 'Analysis only works for explicit z = f(x, y) functions.';
                    return;
                }
                const fxy = document.getElementById('3d-function').value;
                if (!fxy) return;
                const prompt = `Please perform a full analysis of the 3D function:
\\(z = f(x, y) = ${fxy}\\)

I need to know its:
1.  Domain and Range
2.  Intercepts (x, y, and z)
3.  Partial derivatives (\\(f_x\\) and \\(f_y\\))
4.  Critical points (local maxima, minima, saddle points)
`;
                sendToAITutor(prompt);
            });


            // --- "Why" Buttons ---
            explainDerivativeBtn.addEventListener('click', () => {
                const prompt = `Please explain, step-by-step, how to find the derivative of:
\\(f(x) = ${document.getElementById('deriv-fx').textContent}\\)
My calculator says the answer is:
\\(f'(x) = ${document.getElementById('deriv-fpx').textContent}\\)
Please show me all the rules used.`;
                sendToAITutor(prompt);
            });
            
            explainAlgebraBtn.addEventListener('click', () => {
                const prompt = `I just solved a ${algebraVarMode}-variable system...
'${document.getElementById('algebra-solution').textContent}'
...using "Cramer's Rule". Can you please explain how Cramer's Rule works for a ${algebraVarMode}x${algebraVarMode} system?`;
                sendToAITutor(prompt);
            });
            
            explainTrigBtn.addEventListener('click', () => {
                const prompt = `I just solved a triangle, and these were the steps:
---
${document.getElementById('triangle-steps').textContent}
---
Can you please explain the logic? What are the 'Law of Sines' and 'Law of Cosines', and how do I know which one to use?`;
                sendToAITutor(prompt);
            });

            explainPolyBtn.addEventListener('click', () => {
                const prompt = `I'm trying to find the roots of the polynomial:
\\(${document.getElementById('poly-a').value}x^3 + ${document.getElementById('poly-b').value}x^2 + ${document.getElementById('poly-c').value}x + ${document.getElementById('poly-d').value} = 0\\)
My calculator gave me these roots:
${document.getElementById('poly-steps').textContent}
Can you please explain the steps to find these roots?`;
                sendToAITutor(prompt);
            });

            explainMatrixBtn.addEventListener('click', () => {
                const result = document.getElementById('matrix-result-scalar').textContent || "a matrix (see grid)";
                const prompt = `I just performed a matrix operation ('${lastMatrixOp}') and got this result: ${result}.
Can you please explain how this operation (${lastMatrixOp}) works in general for 3x3 matrices?`;
                sendToAITutor(prompt);
            });

            explainIntegralBtn.addEventListener('click', () => {
                const prompt = `I am approximating the integral of:
\\(f(x) = ${calcFunctionInput.value}\\) from \\(a = ${document.getElementById('integral-a').value}\\) to \\(b = ${document.getElementById('integral-b').value}\\)
Using \\(n = ${integralN.value}\\) rectangles, I got an area of:
${document.getElementById('integral-area').textContent}
Can you please explain how a (Midpoint) Riemann Sum is calculated?`;
                sendToAITutor(prompt);
            });

            explainLimitBtn.addEventListener('click', () => {
                const prompt = `I am trying to find the limit of \\(f(x) = ${calcFunctionInput.value}\\) as \\(x\\) approaches \\(${document.getElementById('limit-a').value}\\).
The tables show the function approaching: ${document.getElementById('limit-value').textContent}
Can you please explain what this limit means?`;
                sendToAITutor(prompt);
            });

            // --- NEW: Collaboration Listeners ---
            document.getElementById('start-share-btn').addEventListener('click', startNewShareSession);
            document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);
            document.getElementById('leave-session-btn').addEventListener('click', leaveShareSession);

            // --- Final Initialization ---
            // Removed switchModule('algebra') here, it's now handled by the URL check or defaults
            if (!currentSessionId) {
                switchModule('algebra'); // Start on algebra if not joining a session
            }
            initAiTutor();
        });
    </script>
</body>
</html>